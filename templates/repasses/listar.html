{% extends "base.html" %}

{% block title %}Repasses Financeiros - Conecta Uniforme{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-currency-dollar"></i> Repasses Financeiros</h2>

<!-- Estatísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-primary">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Total de Repasses</h6>
                <h3 class="card-title text-primary">{{ estatisticas.total_repasses }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Valor Total</h6>
                <h3 class="card-title text-success">R$ {{ "%.2f"|format(estatisticas.total_valor) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Pendentes</h6>
                <h4 class="card-title text-warning">
                    {{ estatisticas.pendente.qtd }} 
                    <small class="text-muted">(R$ {{ "%.2f"|format(estatisticas.pendente.valor) }})</small>
                </h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-success">
            <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Concluídos</h6>
                <h4 class="card-title text-success">
                    {{ estatisticas.concluido.qtd }}
                    <small class="text-muted">(R$ {{ "%.2f"|format(estatisticas.concluido.valor) }})</small>
                </h4>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-funnel"></i> Filtros
    </div>
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">Todos</option>
                    <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendente</option>
                    <option value="processando" {% if filtros.status == 'processando' %}selected{% endif %}>Processando</option>
                    <option value="concluido" {% if filtros.status == 'concluido' %}selected{% endif %}>Concluído</option>
                    <option value="cancelado" {% if filtros.status == 'cancelado' %}selected{% endif %}>Cancelado</option>
                </select>
            </div>
            {% if usuario_logado.tipo == 'administrador' and fornecedores %}
            <div class="col-md-3">
                <label class="form-label">Fornecedor</label>
                <select name="fornecedor_id" class="form-select">
                    <option value="">Todos</option>
                    {% for f in fornecedores %}
                    <option value="{{ f.id }}" {% if filtros.fornecedor_id == f.id|string %}selected{% endif %}>
                        {{ f.nome }} - {{ f.razao_social }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            <div class="col-md-2">
                <label class="form-label">Data Início</label>
                <input type="date" name="data_inicio" class="form-control" value="{{ filtros.data_inicio }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Data Fim</label>
                <input type="date" name="data_fim" class="form-control" value="{{ filtros.data_fim }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Valor Mín</label>
                <input type="number" name="valor_min" class="form-control" step="0.01" placeholder="0.00" value="{{ filtros.valor_min }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Valor Máx</label>
                <input type="number" name="valor_max" class="form-control" step="0.01" placeholder="0.00" value="{{ filtros.valor_max }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Por Página</label>
                <select name="per_page" class="form-select">
                    <option value="10" {% if request.args.get('per_page', '20') == '10' %}selected{% endif %}>10</option>
                    <option value="20" {% if request.args.get('per_page', '20') == '20' %}selected{% endif %}>20</option>
                    <option value="50" {% if request.args.get('per_page', '20') == '50' %}selected{% endif %}>50</option>
                    <option value="100" {% if request.args.get('per_page', '20') == '100' %}selected{% endif %}>100</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Filtrar
                </button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <a href="{{ url_for('repasses.listar') }}" class="btn btn-secondary w-100">
                    <i class="bi bi-x-circle"></i> Limpar
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Lista -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Fornecedor</th>
                        <th>Pedido</th>
                        <th>Valor Bruto</th>
                        <th>Taxa ({{ "%.1f"|format(taxa_plataforma) }}%)</th>
                        <th>Valor Líquido</th>
                        <th>Status</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for repasse in repasses %}
                    <tr>
                        <td>{{ repasse.id }}</td>
                        <td>{{ repasse.fornecedor_usuario_nome }}</td>
                        <td>{{ repasse.pedido_id or '-' }}</td>
                        <td>R$ {{ "%.2f"|format(repasse.valor) }}</td>
                        <td>R$ {{ "%.2f"|format(repasse.taxa_plataforma) }}</td>
                        <td><strong>R$ {{ "%.2f"|format(repasse.valor_liquido) }}</strong></td>
                        <td>
                            {% if repasse.status == 'pendente' %}
                            <span class="badge bg-warning">Pendente</span>
                            {% elif repasse.status == 'processando' %}
                            <span class="badge bg-info">Processando</span>
                            {% elif repasse.status == 'concluido' %}
                            <span class="badge bg-success">Concluído</span>
                            {% elif repasse.status == 'cancelado' %}
                            <span class="badge bg-danger">Cancelado</span>
                            {% endif %}
                        </td>
                        <td>{{ repasse.data_repasse.strftime('%d/%m/%Y') if repasse.data_repasse else '-' }}</td>
                        <td>
                            {% if usuario_logado.tipo == 'administrador' and repasse.status == 'pendente' %}
                            <form method="POST" action="{{ url_for('repasses.processar', id=repasse.id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-success" title="Processar">
                                    <i class="bi bi-check-circle"></i>
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('repasses.cancelar', id=repasse.id) }}" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-danger" title="Cancelar" onclick="return confirm('Confirma cancelamento?')">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </form>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center">Nenhum repasse encontrado</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginação -->
        {% if pagination and pagination.pages > 1 %}
        <nav aria-label="Navegação de páginas" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('repasses.listar', page=pagination.prev_num, per_page=request.args.get('per_page', 20), **filtros) if pagination.has_prev else '#' }}">
                        Anterior
                    </a>
                </li>
                
                {% for page_num in pagination.iter_pages() %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('repasses.listar', page=page_num, per_page=request.args.get('per_page', 20), **filtros) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('repasses.listar', page=pagination.next_num, per_page=request.args.get('per_page', 20), **filtros) if pagination.has_next else '#' }}">
                        Próxima
                    </a>
                </li>
            </ul>
            <p class="text-center text-muted">
                Mostrando página {{ pagination.page }} de {{ pagination.pages }} ({{ pagination.total }} repasses no total)
            </p>
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}
