{% extends "base.html" %}

{% block title %}Passkeys - Conecta Uniforme{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-7">
    <div class="card">
      <div class="card-body p-4">
        <h3 class="mb-3"><i class="bi bi-fingerprint me-2"></i>Passkeys (Chaves de Segurança)</h3>
        <p class="text-muted">Cadastre uma passkey para fazer login de forma rápida e segura usando Windows Hello, Face/Touch ID ou chave de segurança.</p>
        <div class="alert alert-info small">
          <div class="d-flex"><i class="bi bi-info-circle me-2"></i>
            <div>
              A passkey fica vinculada ao seu e-mail ({{ usuario.email }}). Após cadastrar, você poderá escolher o perfil de acesso (Administrador, Escola, Fornecedor, Responsável) no momento do login. Você pode cadastrar mais de um dispositivo.
            </div>
          </div>
        </div>
        <div class="d-grid">
          <button class="btn btn-success btn-lg" id="btnRegistrarPasskey"><i class="bi bi-plus-circle"></i> Cadastrar Passkey</button>
        </div>
        <div id="mensagem" class="mt-3" style="display:none"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const btn = document.getElementById('btnRegistrarPasskey');
  const msg = document.getElementById('mensagem');
  function showMsg(kind, text){
    msg.className = 'alert alert-' + kind;
    msg.textContent = text;
    msg.style.display = 'block';
  }
  function b64urlToArrayBuffer(b64url){
    const pad = '='.repeat((4 - b64url.length % 4) % 4);
    const b64 = b64url.replace(/-/g,'+').replace(/_/g,'/') + pad;
    const raw = atob(b64);
    const buffer = new ArrayBuffer(raw.length);
    const view = new Uint8Array(buffer);
    for(let i=0;i<raw.length;i++){view[i]=raw.charCodeAt(i);} return buffer;
  }
  function arrayBufferToB64url(buf){
    const bytes = new Uint8Array(buf);
    let bin = '';
    bytes.forEach(b=>bin += String.fromCharCode(b));
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  btn.addEventListener('click', async function(){
    msg.style.display='none';
    try{
      const resp = await fetch('/auth/webauthn/registro/opcoes');
      const options = await resp.json();
      if(options.erro){
        showMsg('danger', 'Erro ao obter opções: ' + options.erro);
        return;
      }
      options.challenge = b64urlToArrayBuffer(options.challenge);
      options.user.id = b64urlToArrayBuffer(options.user.id);
      if(options.excludeCredentials){
        options.excludeCredentials = options.excludeCredentials.map(c=>({type:c.type, id:b64urlToArrayBuffer(c.id)}));
      }
      const cred = await navigator.credentials.create({publicKey: options});
      const data = {
        id: cred.id,
        rawId: arrayBufferToB64url(cred.rawId),
        type: cred.type,
        response: {
          attestationObject: arrayBufferToB64url(cred.response.attestationObject),
          clientDataJSON: arrayBufferToB64url(cred.response.clientDataJSON)
        },
        transports: cred.response.getTransports ? cred.response.getTransports() : []
      };
      const finish = await fetch('/auth/webauthn/registro', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
      const rjson = await finish.json();
      if(rjson.status === 'ok'){
        showMsg('success', 'Passkey cadastrada com sucesso! Você já pode usá-la no próximo login.');
      }else{
        showMsg('danger', 'Falha ao cadastrar passkey: ' + (rjson.erro || 'desconhecido') + (rjson.detalhes ? ' - ' + rjson.detalhes : ''));
      }
    }catch(e){
      console.error('Erro detalhado:', e);
      showMsg('danger', 'Erro ao cadastrar passkey: ' + e.message + '. Verifique suporte do navegador e tente novamente.');
    }
  });
})();
</script>
{% endblock %}
